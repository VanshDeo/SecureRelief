generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  DONOR
  BENEFICIARY
  VENDOR
  ADMIN
  ORACLE
}

enum Status {
  ACTIVE
  PENDING
  SUSPENDED
  BLOCKED
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  passwordHash  String
  walletAddress String   @unique
  role          Role
  status        Status   @default(PENDING)
  nonce         String?  // For SIWE
  balance       Decimal  @default(0) @db.Decimal(18, 2) // Mock Stablecoin Balance
  
  // Relations
  receivedVouchers Voucher[] @relation("BeneficiaryVouchers")
  redeemedVouchers Voucher[] @relation("VendorRedemptions")
  disasterReports  DisasterReport[] @relation("ReportedDisasters")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}


model DisasterZone {
  id            String     @id @default(uuid())
  name          String
  location      String
  latitude      Float
  longitude     Float
  budget        Decimal    @default(0) @db.Decimal(18, 2)
  allocated     Decimal    @default(0) @db.Decimal(18, 2)
  distributed   Decimal    @default(0) @db.Decimal(18, 2)
  beneficiaries Int        @default(0)
  status        ZoneStatus @default(PENDING)
  severity      Severity   @default(MEDIUM)
  type          String     // e.g., "Cyclone", "Flood"
  radius        Float      @default(1000) // Radius in meters
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  donations     Donation[]
  vouchers      Voucher[]
}

model Donation {
  id           String       @id @default(uuid())
  amount       Decimal      @db.Decimal(18, 2)
  donorAddress String?
  zoneId       String
  zone         DisasterZone @relation(fields: [zoneId], references: [id])
  timestamp    DateTime     @default(now())
  status       String       @default("COMPLETED")
  currency     String       @default("USDC")
  voucher      Voucher?
}

enum ZoneStatus {
  ACTIVE
  CRITICAL
  PENDING
  COMPLETED
  ARCHIVED
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Voucher {
  id            String        @id @default(uuid())
  amount        Decimal       @db.Decimal(18, 2) // Value in USDC
  qrCode        String        @unique // Unique token string for the QR
  status        VoucherStatus @default(ISSUED)
  
  beneficiaryId String
  beneficiary   User          @relation("BeneficiaryVouchers", fields: [beneficiaryId], references: [id])
  
  zoneId        String
  zone          DisasterZone  @relation(fields: [zoneId], references: [id])
  
  vendorId      String?
  vendor        User?         @relation("VendorRedemptions", fields: [vendorId], references: [id])

  donationId    String?       @unique
  donation      Donation?     @relation(fields: [donationId], references: [id])
  
  createdAt     DateTime   @default(now())
  redeemedAt    DateTime?
}

enum VoucherStatus {
  ISSUED
  REDEEMED
  EXPIRED
  CANCELLED
}



model DisasterReport {
  id            String       @id @default(uuid())
  title         String
  description   String
  location      String
  latitude      Float?
  longitude     Float?
  disasterType  String       // e.g., "Flood", "Earthquake", "Fire"
  severity      Severity     @default(MEDIUM)
  status        ReportStatus @default(PENDING)
  
  reportedById  String
  reportedBy    User         @relation("ReportedDisasters", fields: [reportedById], references: [id])
  
  images        String[]     // Array of image URLs
  contactInfo   String?
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  reviewedAt    DateTime?
  reviewedBy    String?
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  RESOLVED
}
